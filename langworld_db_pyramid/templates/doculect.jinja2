{% extends "base.jinja2" %}
{% set name_attr = "name_" + request.locale_name %}
{% set aliases_attr = "aliases_" + request.locale_name %}

{% block content_top %}
<div class="w3-twothird w3-container">
  <h1 class="w3-text-dark-blue-grey">{{ doculect[name_attr] }} {{ doculect.type[name_attr] }} {% if doculect.is_extinct %}†{% endif %}</h1>
</div>
{% endblock content_top %}

{% block content %}

<div class="w3-margin-left">
    {% if doculect[aliases_attr] %}
  <p>{% trans %}Альтернативные названия{% endtrans %}: <span class="font-normal">{{ doculect[aliases_attr] }}</span></p>
    {% endif %}

  <p><a href="{{ request.static_url('langworld_db_pyramid:static/pdf_volumes/11.pdf') }}" target="_blank">{% trans %}Открыть в энциклопедии{% endtrans %}</a></p>

  <h2 class="w3-text-darkest-blue-grey">{% trans %}Генеалогия{% endtrans %}</h2>
  <p>
  {# this loop is a workaround of absence of recursive if's. I have to make a one-item list to be able to loop #}
  {% for parent in [doculect.family.parent] recursive %}
    {% if parent != None %}
        {{ loop([parent.parent]) }}  {# I need to start at the top, so recursion comes first #}
        <a href="/{{ request.locale_name }}/family/{{ parent.man_id }}?show_doculect={{ doculect.man_id }}">{{ parent[name_attr] }}</a> &rarr;
    {% endif %}
  {% endfor %}
  <a href="/{{ request.locale_name }}/family/{{ doculect.family.man_id }}?show_doculect={{ doculect.man_id }}">{{ doculect.family[name_attr] }}</a>
  </p>

  <h2 class="w3-text-darkest-blue-grey">{% trans %}География{% endtrans %}</h2>
    <p>{% trans %}Основная страна{% endtrans %}: <span class="font-normal">{{ doculect.main_country[name_attr] }}</span>
    (<a href="/{{ request.locale_name }}/doculects/map?lat={{ doculect.latitude }}&long={{ doculect.longitude }}&show_doculect={{ doculect.man_id }}">{% trans %}посмотреть на карте{% endtrans %}</a>)
    </p>

  {% if doculect.glottocodes or doculect.iso_639p3_codes %}
      <h2 class="w3-text-darkest-blue-grey">{% trans %}Идентификаторы{% endtrans %}</h2>
      <ul>

      {% if doculect.glottocodes %}
      <li>Glottolog:
        {% for glottocode in doculect.glottocodes|sort(attribute="code") %}
        <span class="font-normal"><a href="https://glottolog.org/resource/languoid/id/{{ glottocode.code }}" target="_blank">{{ glottocode.code }}</a></span>{% if not loop.last %}, {% endif %}
        {% endfor %}
      </li>
      {% endif %}

      {% if doculect.iso_639p3_codes %}
      <li>ISO-639-3:
        {% for iso_code in doculect.iso_639p3_codes|sort(attribute="code") %}
        <span class="font-normal"><a href="https://iso639-3.sil.org/code/{{ iso_code.code }}" target="_blank">{{ iso_code.code }}</a></span>{% if not loop.last %}, {% endif %}
        {% endfor %}
      </li>
      {% endif %}

      </ul>
  {% endif %}

  <h2 class="w3-text-darkest-blue-grey">{% trans %}Признаки{% endtrans %}</h2>

  {% for category in categories %}
      <h3 class="w3-text-darkest-blue-grey">{{ category[name_attr] }}</h3>
      {% set values_to_list = doculect.feature_values|selectattr("feature.category.id", "eq", category.id)|selectattr("type.entails_empty_value", "false")|sort(attribute="feature.id") %}

      {% if not values_to_list %}<p>{% trans %}Нет заполненных признаков для этого языка.{% endtrans %}</p>
      {# I realise that ^ this message ^ will not show in English version if a category only contains
      'custom' values for this doculect.  An empty list will be rendered instead.
      But this is a rare situation and custom values should not stay for too long anyway. #}

      {% else %}
          <ul>
          {% for value in values_to_list %}
            {% if not (request.locale_name == 'en' and value.type.name == 'custom') %}
                <li>
                    <a href="/{{ request.locale_name }}/feature/{{ value.feature.man_id }}{% if value.type.name=='listed' %}?show_doculect={{ doculect.man_id}}{% endif %}">
                        {{ value.feature[name_attr] }} ({{ value.feature.man_id }})
                    </a>: {{ value[name_attr]}} {%if value.man_id %}({{ value.man_id }}){% endif %}

                    {# comments are only available in Russian so far #}
                    {% if request.locale_name == 'ru' %}
                        {% for comment in value.doculect_comments if comment.doculect == doculect %}<br/><span class="comment">{{ comment.text_ru }}</span>{% endfor %}
                    {% endif %}
                </li>
            {% endif %}
          {% endfor %}
          </ul>
      {% endif %}
  {% endfor %}

  <h2 class="w3-text-darkest-blue-grey">{% trans %}Незаполненные признаки{% endtrans %}</h2>

  {% if doculect.feature_values|selectattr("type.name", "eq", "not_stated")|list %}
      <h3 class="w3-text-darkest-blue-grey">{% trans %}В энциклопедии отсутствует информация{% endtrans %}</h3>
      <ul>
      {% for value in doculect.feature_values|sort(attribute="feature.id") %}
        {% if value.type.name == 'not_stated' %}
            <li>
                {{ value.feature[name_attr] }} ({{ value.feature.man_id }})
                {% if request.locale_name == 'ru' %}
                    {% for comment in value.doculect_comments if comment.doculect == doculect %}<br/><span class="comment">{{ comment.text_ru }}</span>{% endfor %}
                {% endif %}
            </li>
        {% endif %}
      {% endfor %}
      </ul>
  {% endif %}

  {% if doculect.feature_values|selectattr("type.name", "eq", "explicit_gap")|list %}
      <h3 class="w3-text-darkest-blue-grey">{% trans %}В энциклопедии присутствует явное указание на отсутствие данных{% endtrans %}</h3>
      <ul>
      {% for value in doculect.feature_values|sort(attribute="feature.id") %}
        {% if value.type.name == 'explicit_gap' %}
            <li>
                {{ value.feature[name_attr] }} ({{ value.feature.man_id }})
                {% if request.locale_name == 'ru' %}
                    {% for comment in value.doculect_comments if comment.doculect == doculect %}<br/><span class="comment">{{ comment.text_ru }}</span>{% endfor %}
                {% endif %}
            </li>
        {% endif %}
      {% endfor %}
      </ul>
  {% endif %}

  {% if doculect.feature_values|selectattr("type.name", "eq", "not_applicable")|list %}
      <h3 class="w3-text-darkest-blue-grey">{% trans %}Признак неприменим к этому языку{% endtrans %}</h3>
      <ul>
      {% for value in doculect.feature_values|sort(attribute="feature.id") %}
        {% if value.type.name == 'not_applicable' %}
            <li>
                {{ value.feature[name_attr] }} ({{ value.feature.man_id }})
                {% if request.locale_name == 'ru' %}
                    {% for comment in value.doculect_comments if comment.doculect == doculect %}<br/><span class="comment">{{ comment.text_ru }}</span>{% endfor %}
                {% endif %}
            </li>
        {% endif %}
      {% endfor %}
      </ul>
  {% endif %}

  {% if request.locale_name == 'ru' %}
    <p>{{ doculect.comment_ru }}</p>
  {% endif %}

</div>
{% endblock content %}
